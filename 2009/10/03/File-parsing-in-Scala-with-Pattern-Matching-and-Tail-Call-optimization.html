<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <title>File parsing in Scala with Pattern Matching and Tail-Call optimization</title>
    <meta name="description" content="" />

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" href="//sgalles.github.io/themes/Roon/favicon.ico">

    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Merriweather:400,700,400italic,700italic|Open+Sans:400italic,700italic,700,400">
    <link rel="stylesheet" type="text/css" href="//sgalles.github.io/themes/Roon/assets/css/screen.css?v=1.0.0" />

    <link rel="canonical" href="https://sgalles.github.io/2009/10/03/File-parsing-in-Scala-with-Pattern-Matching-and-Tail-Call-optimization.html" />
    
    <meta property="og:site_name" content="void   techBlog()   { world.forEach(person -&gt; say( &quot;Hello &quot; + person )); }" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="File parsing in Scala with Pattern Matching and Tail-Call optimization" />
    <meta property="og:description" content="In the process of learning Scala, I had to find a subject for my very first &quot;Non Hello World&quot; program in Scala. It was a good opportunity to code a script I wanted to write a long time ago in..." />
    <meta property="og:url" content="https://sgalles.github.io/2009/10/03/File-parsing-in-Scala-with-Pattern-Matching-and-Tail-Call-optimization.html" />
    <meta property="article:published_time" content="2009-10-02T22:00:00.000Z" />
    <meta property="article:modified_time" content="2016-05-25T06:05:14.945Z" />
    
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="File parsing in Scala with Pattern Matching and Tail-Call optimization" />
    <meta name="twitter:description" content="In the process of learning Scala, I had to find a subject for my very first &quot;Non Hello World&quot; program in Scala. It was a good opportunity to code a script I wanted to write a long time ago in..." />
    <meta name="twitter:url" content="https://sgalles.github.io/2009/10/03/File-parsing-in-Scala-with-Pattern-Matching-and-Tail-Call-optimization.html" />
    
    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Article",
    "publisher": "void   techBlog()   { world.forEach(person -&gt; say( &quot;Hello &quot; + person )); }",
    "author": {
        "@type": "Person",
        "name": "Stephane Gallès",
        "image": "https://avatars.githubusercontent.com/u/153065?v=3",
        "url": "undefined/author/undefined",
        "sameAs": "https://plus.google.com/108710960409593252381"
    },
    "headline": "File parsing in Scala with Pattern Matching and Tail-Call optimization",
    "url": "https://sgalles.github.io/2009/10/03/File-parsing-in-Scala-with-Pattern-Matching-and-Tail-Call-optimization.html",
    "datePublished": "2009-10-02T22:00:00.000Z",
    "dateModified": "2016-05-25T06:05:14.945Z",
    "description": "In the process of learning Scala, I had to find a subject for my very first &quot;Non Hello World&quot; program in Scala. It was a good opportunity to code a script I wanted to write a long time ago in..."
}
    </script>

    <meta name="generator" content="Ghost ?" />
    <link rel="alternate" type="application/rss+xml" title="void   techBlog()   { world.forEach(person -&gt; say( &quot;Hello &quot; + person )); }" href="https://sgalles.github.io/rss" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/default.min.css">
</head>
<body class="post-template  noimage">

    


    <article role="main" class="">
        <header>
            <a href="https://sgalles.github.io" id="home_link">«</a>
            <div class="meta"><time datetime="2009-10-03"><a href="/2009/10/03/File-parsing-in-Scala-with-Pattern-Matching-and-Tail-Call-optimization.html">October 03, 2009</a></time> <span class="count" id="js-reading-time"></span></div>
            <h1>File parsing in Scala with Pattern Matching and Tail-Call optimization</h1>
        </header>

        <div class="text" id="js-post-content">
            <div class="paragraph">
<p>In the process of learning Scala, I had to find a subject for my very first "Non Hello World" program in Scala. It was a good opportunity to code a script I wanted to write a long time ago in order to automatize the sync of the podcasts I download for my Mp3 player (I have very specific use cases that are not addressed by the usual podcast downloader software).</p>
</div>
<div class="paragraph">
<p>As my player is an MTP player,the script launches some mtp-tools command line utilities of <a href="http://libmtp.sourceforge.net/">libmtp</a> to drive the player.</p>
</div>
<div class="paragraph">
<p>In particular the mtp-tracks command lists some information for the tracks stored into the player. The output of the command looks like :</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Attempting to connect device(s)

mtp-tracks: Successfully connected

Friendly name: My Zen

Track ID: 40337

Title: Java Posse #273 - Roundup 09 - Managing Technical Debt

Artist: Tor Norbye, Carl Quinn, Joe Nuxoll, Dick Wall

Genre: Podcast

Album: The Java Posse

Origfilename: Tor Norbye, Carl Quinn, Joe Nuxoll, Dick Wall-Java Posse #273 - Roundup 09 - Managing Technical Debt.mp3

Track number: 0

Duration: 3809000 milliseconds

File size 45766104 bytes

Filetype: ISO MPEG-1 Audio Layer 3

Use count: 9 times

Track ID: 41737

Title: Java Posse #272 - Newscast for July 30th 2009

Artist: Tor Norbye, Carl Quinn, Joe Nuxoll, Dick Wall

Genre: Podcast

...</pre>
</div>
</div>
<div class="paragraph">
<p>So basically, in order to parse the file I must skip the header (there&#8217;s a footer too) and find each track information. It looks like a job for Pattern Matching on list with a mix of RegExp matching. And as he goal is also to learn Scala (And improve my Functional Programming skills) I wanted to code the parsing without any mutable object (yes, I&#8217;m trying to follow the rules described in <a href="http://www.artima.com/shop/programming_in_scala">Programming in Scala</a>)</p>
</div>
<div class="paragraph">
<p>So here is the part of the code that parses the mtp-tracks output :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-scala" data-lang="scala">//let's define some RegExp
Expval TrackId = """Track ID: ([0-9]+)""".r
val Title = """ *Title: (.+)""".r
val Album = """ *Album: (.+)""".r
val Filename = """ *Origfilename: (.+)""".r

//The recursive function
def collect(lines: List[String],tracks: List[MtpTrack]): List[MtpTrack] = {
  lines match{
   case TrackId(id) :: Title(title) :: _ :: _:: Album(album) :: Filename(filename) :: rest =&gt;
      collect(rest,new MtpTrack(id,album,title,filename) :: tracks)
   case _ :: rest =&gt; collect(rest,tracks)
   case Nil =&gt; tracks
   }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The list of lines of the mtp-tracks command output are stored in the lines list. This recursive function can then be called with collect(lines,Nil), it returns a list of parsed MtpTrack object.</p>
</div>
<div class="paragraph">
<p>To explain the three pattern matching cases of the collect function, I must first explain how pattern matching works for regexp.</p>
</div>
<div class="paragraph">
<p>In this code, four matchers are defined for four regexp : TrackId, Title, Album and Filename. For instance, if one line matches on the expression Track(id) the first group of the regexp is captures in the id variable.</p>
</div>
<div class="paragraph">
<p>So, now, the description of the three cases after lines match</p>
</div>
<div class="listingblock">
<div class="content">
<pre>caseTrackId(id) :: Title(title) :: _ :: _:: Album(album) :: Filename(filename) :: rest</pre>
</div>
</div>
<div class="paragraph">
<p>this one says "match on list if list first element matches the regexp TrackId, then regexp Title, then whatever twice, then regexp Album, then regexp Filename. And also, if it matches extract the rest of the list in the rest variable. Also, capture all regexp groups in the declared variables id,title,album and filename". Rather powerfull.</p>
</div>
<div class="paragraph">
<p>Then, with the matched information we create an MtpTrack object that is added to tracks, the already collected list of MtpTrack (actually a new list is created as a List in Scala is immutable).</p>
</div>
<div class="listingblock">
<div class="content">
<pre>case _ :: rest</pre>
</div>
</div>
<div class="paragraph">
<p>this one is tried when the previous case does not match. It says "if list starts with any element, extract the rest of the list after this element in a rest variable". rest may also by empty.case Nil</p>
</div>
<div class="paragraph">
<p>this one is the stop clause for the recursion, it matches when the list is empty.</p>
</div>
<div class="paragraph">
<p>Thanks to the power of pattern matching composition (RexgExp in list), header and footer are automatically ignored. And as the function ends with a direct recursive call, the Scala compiler has compiled the code with <a href="http://en.wikipedia.org/wiki/Tail_call">tail-call optimisation</a>, so not stack overflow, even with very large command output.</p>
</div>
<div class="paragraph">
<p>I must say that I was amazed by how much can be expressed in Scala with so little lines of code. And as I&#8217;m a beginner in Scala, there are surely even smaller and idiomatic ways to code the same functionnality.</p>
</div>
        </div>

        <menu>
            <a href="" id="btn_share" class="btn" title="Share">
                <span aria-hidden="true" data-icon="S"></span>
                <strong>Share</strong>
            </a>
            <a href="http://twitter.com/share?text=File%20parsing%20in%20Scala%20with%20Pattern%20Matching%20and%20Tail-Call%20optimization&url=https://sgalles.github.io/2009/10/03/File-parsing-in-Scala-with-Pattern-Matching-and-Tail-Call-optimization.html" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;" id="btn_comment" class="btn" target="_blank">
                <span aria-hidden="true" data-icon="C"></span> Comment on Twitter
            </a>
        </menu>


        <footer class="post-footer" role="contentinfo">

            <div class="vcard">
                <!-- <a href="https://sgalles.github.io/rss" id="btn_feed" class="btn" title="Feed" target="_blank">
                    <span aria-hidden="true" data-icon=")"></span>
                    <strong>Feed</strong>
                </a> -->

                <a href="" class="photo">
                    <span style="background-image: url('https://avatars.githubusercontent.com/u/153065?v=3');">
                        <img src="https://avatars.githubusercontent.com/u/153065?v=3" alt="Stephane Gallès">
                    </span>
                </a>

                <div class="details">
                    <h4><a href="" class="url n">Stephane Gallès</a></h4>
                    
                    <a href="https://plus.google.com/108710960409593252381" class="js-remove-domain-schema">https://plus.google.com/108710960409593252381</a>
                </div>
            </div>

            <div id="user_bio">
                <div class="inner">
                    
                </div>
            </div>

        </footer>




    </article>

    <div id="share_modal">
        <div class="wrap">
            <div class="inner">
                <header>
                    Share
                    <a href="" class="close" title="Close">&times;</a>
                </header>

                <div class="roon-share-links">
                    <a href="https://twitter.com/share" class="twitter-share-button" data-dnt="true">Tweet</a>
                    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>

                    <div id="fb-elems">
                        <div id="fb-root"></div>
                        <script>(function(d, s, id) {
                        var js, fjs = d.getElementsByTagName(s)[0];
                        if (d.getElementById(id)) return;
                        js = d.createElement(s); js.id = id;
                        js.src = "//connect.facebook.net/en_US/all.js#xfbml=1&appId=463438580397968";
                        fjs.parentNode.insertBefore(js, fjs);
                        }(document, 'script', 'facebook-jssdk'));</script>
                        <div class="fb-like" data-send="false" data-layout="button_count" data-width="110" data-show-faces="false" data-font="arial"></div>
                    </div>

                    <div id="pinit-btn">
                        <a href="//pinterest.com/pin/create/button/?url=https://sgalles.github.io/2009/10/03/File-parsing-in-Scala-with-Pattern-Matching-and-Tail-Call-optimization.html&amp;description=File%20parsing%20in%20Scala%20with%20Pattern%20Matching%20and%20Tail-Call%20optimization-void%20%20%20techBlog()%20%20%20%7B%20world.forEach(person%20-%3E%20say(%20%22Hello%20%22%20%2B%20person%20))%3B%20%7D " data-pin-do="buttonPin" data-pin-config="beside"><img src="//assets.pinterest.com/images/pidgets/pin_it_button.png"></a>
                        <script type="text/javascript" src="//assets.pinterest.com/js/pinit.js"></script>
                    </div>
                </div>
            </div>
        </div>
    </div>






    <script>

            function get_text(el) {
                ret = "";
                var length = el.childNodes.length;
                for(var i = 0; i < length; i++) {
                    var node = el.childNodes[i];
                    if(node.nodeType != 8) {
                        ret += node.nodeType != 1 ? node.nodeValue : get_text(node);
                    }
                }
                return ret;
            }
            function reading_time () {
                var post_content = document.getElementById('js-post-content');
                if (post_content) {
                    var words = get_text(post_content),
                        count = words.split(/\s+/).length,
                        read_time = Math.ceil((count / 150)),
                        read_time_node = document.createTextNode(read_time + ' min read');
                    document.getElementById('js-reading-time').appendChild(read_time_node);
                }
            }

        function no_schema_links () {
            var links = document.querySelectorAll('.js-remove-domain-schema');
            if (links) {
                for (i = 0; i < links.length; ++i) {
                    var link = links[i],
                        text = link.innerHTML,
                        no_schema = text.replace(/.*?:\/\//g, "");
                    link.innerHTML = no_schema;
                }
            }
        }

        window.onload = function () {
            no_schema_links();

            reading_time();
        }
    </script>

    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js?v="></script> <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.9.0/moment-with-locales.min.js?v="></script> <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js?v="></script> 
      <script type="text/javascript">
        jQuery( document ).ready(function() {
          // change date with ago
          jQuery('ago.ago').each(function(){
            var element = jQuery(this).parent();
            element.html( moment(element.text()).fromNow());
          });
        });

        hljs.initHighlightingOnLoad();      
      </script>

        <script>
            $(function(){
                var share_modal = $("#share_modal"),
                    update_social_links = true;

                $("#btn_share").click(function(){
                    var that = $(this);
                    share_modal.fadeIn(200);
                    return false;
                });

                share_modal.click(function(e){
                    if (e.target.className == "wrap" || e.target.id == "share_modal") {
                        share_modal.fadeOut(200);
                    }
                    return false;
                });

                share_modal.find("div.inner > header > a.close").click(function(){
                    share_modal.fadeOut(200);
                    return false;
                });
            });
        </script>



</body>
</html>
